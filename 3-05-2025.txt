------STORED PROCEDURE-----


CREATE PROC GETALLROLES
AS 
BGIN
SELECT *FROM ROLES
END

EXEC GETALLROLES

CREATE PROC ADDNEWUSER
@NAME NVARCHAR(50),
@EMAIL NVARCHAR(50),
@PASSWORD NVARCHAR(30),
@ROLE BIGINT,
@PHONE NVARCHAR(20)
AS
INSERT INTO USERINFO(USERNAME,ROLEID,EMAIL,[PASSWORD],PHONE)
VALUES(@NAME,@ROLEID,@EMAIL,@PASSWORD,@PHONE)

EXEC ADDNEWUSER


CREATE PROC GETALLUSERS
AS
SELECT *FROM USERINFO 

CREATE PROC DELETEUSER
@USERID BIGINT
AS
DELETE[DBO].[USERINFO]
WHERE USERID=@USERID

EXEC DELETEUSER


CREATE PROC GETUSERBYEMAIL
@EMAIL NVARCHAR(100),
@PASSWORD NVARCHAR(30)
AS
SELECT *FROM USERINFO
WHERE EMAIL=@EMAIL

CREATE PROC VALIATEUSER
@EMAIL NVARCHAR(100),
@PASSWORD NVARCHAR(30)
AS
SELECT *FROM USERINFO
WHERE EMAIL=@EMAIL AND [PASSWORD]=@PASSWORD

ALTER PROC GETALLUSERS
AS
SELECT U.*,R.ROLENAME USERROLENAME FROM USERINFO U
JOIN USERROLES R ON U.[ROLE]=R.ROLEID

EXEC ADDNEWUSER 'FARZANA',4,'FARZANA@TASKAPP','QAPASS456','9876543215'

CREATE PROC GETPMS
AS
SELECT *FROM USERINFO
WHERE ROLEID=2

EXEC GETPMS

CREATE PROC ADDPROJECT
@TITLE NVARCHAR(500),
@DESCRIPTION NVARCHAR(500),
@STATEDATE DATE,
@ENDDATE DATE,
@PM BIGINT
AS
BEGIN
DECLARE @NEW_PROJID BIGINT=0
BEGIN TRANSACTION
  BEGIN TRY
    IF NOT EXISTS(SELECT *FROM USERINFO WHERE USERID=@PM AND ROLE=2
     THROW 'USER IS NOT IN PM ROLE',1

     INSERT INTO PROJECT(TITLE,[DESCRIPTION],STARTDATE,ENDDATE)
     VALUES(@TITLE,@DESCRIPTION,@STARTDATE,@ENDDATE) 
        SET @NEW_PROJID=SCOPE_IDENTITY()
        PRINT @NEW_PROJID=SCOPE_IDENTITY()
     INSERT INTO PROJECTMEMBER(PROJID,USERID)
     VALUES(@NEW_PROJID,@PM)

     COMMIT TRANSACTION
  END TRY
  BEGIN CATCH
  END CATCH
END

EXEC ADDPROJECT'TASKMANAGER SYSTEM',PROJECT MANAGAEMENT TOOL FOR DEVLOPERS AND QA','2025-04-01',NULL,


CREATE PROC GETUSERBYROLE
@ROLENAME NVARCHAR(20)
AS
SELECT *FROM USERINFO U
JOIN ROLE R ON U.[ROLE]=R.ROLEID
WHERE R.ROLENAME=@ROLENAME

EXEC GETUSERBYROLE 'QA'


CREATE PROC GETPROJECTMEMBERS
@PROJID BIGINT
AS
BEGIN
SELECT UI.*,R.* FROM PROJECTMEMBER PMEM
JOIN PROJECTS PR ON PMEM.PROJID=PR.PROJECTID
JOIN USERINFO UI ON PMEM.USERID=UI.USERID
JOIN ROLE R ON UI.ROLE=R.ROLEID
WHERE PMEM.PROJID=@PROJID
END


CREATE PROC ADDPROJECTMEMBER
@ROLID BIGINT,
@USERID BIGINT,
AS
BEGIN
	IF NOT EXISTS (SELECT *FROM USERINFO WHERE USERID=@USERID AND ROLEID=2)
INSERT INTO PROJECTMEMBER(PROJID,USERID)
VALUES(@PROJID,@USERID)

EXEC GETALLUSER
EXEC ADDPROJECTMEMBER,3,1

CREATE PROC REMOVEPROJECTMEMBER
@MEMBERID
AS
BEGIN
IF NOT EXISTS(
SELECT *FROM PROJECTMEMBER 
JOIN USERINFO UI PMEM.USERID=UI.USERID
WHERE UI.ROLID=2 AND PMEM.MEMBERID=@MEMBERID
)
	     DELETE PROJECTMEMBER WHERE MEMBERID=@MEMBERID
	ELSE
	    THROW 50002,'MEMBER IS IN PM ROLE'
END  

EXEC  REMOVEPROJECTMEMBER 1


CREATE PROC ADDTASK
     @TaskTitle VARCHAR(100) NOT NULL,
     @Description TEXT NULL,
     @AssignedTo INT,
     @TaskType VARCHAR(20) ,
     @StartDate DATE NULL,
     @EndDate DATE NULL,
     @TaskStatusId INT,
     @PROJID 
AS
BEGIN
INSERT INTOTASK [TASKTITLE],[Description],[AssignedTo],[TaskType],[StartDate],[EndDate],[TaskStatusId],[PROJECTID]
VALUES(@TaskTitle,@Description,@AssignedTo,@TaskType,@StartDate, @EndDate ,@TaskStatusId,@PROJID)
END

EXEC ADDTASK 'LOGIN ISSUE','LOGIN FAILS WITH ERROR',22,'BUG',2025-04-05',NULL,1,2
                     	